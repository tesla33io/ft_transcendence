services:
  # ===== ADD THIS ENTIRE BLOCK (NEW SERVICE) =====
  traefik:
    image: traefik:v2.10                    # ✅ Traefik Docker image
    container_name: traefik                 # ✅ Container name
    
    command:
      # Enable Docker provider (read container labels)
      - --providers.docker=true                           # ✅ Use Docker as config source
      - --providers.docker.exposedbydefault=false         # ✅ Don't expose all containers automatically
      - --providers.docker.network=pong-network           # ✅ Which network to use
      
      # HTTP entrypoint (port 80) - will redirect to HTTPS
      - --entrypoints.web.address=:80                     # ✅ Listen on port 80
      - --entrypoints.web.http.redirections.entrypoint.to=websecure        # ✅ Redirect HTTP to HTTPS
      - --entrypoints.web.http.redirections.entrypoint.scheme=https        # ✅ Use HTTPS scheme
      
      # HTTPS entrypoint (port 443)
      - --entrypoints.websecure.address=:443              # ✅ Listen on port 443 (HTTPS)
      - --entrypoints.websecure.http.tls=true             # ✅ Enable TLS/SSL
      
      # Dashboard (monitoring UI)
      - --api.dashboard=true                              # ✅ Enable dashboard
      - --api.insecure=true                               # ✅ Allow dashboard without auth (dev only!)
      
      # Logging
      - --log.level=INFO                                  # ✅ Log level
      - --accesslog=true                                  # ✅ Enable access logs
    
    ports:
      - "80:80"       # ✅ Expose HTTP (will redirect to HTTPS)
      - "443:443"     # ✅ Expose HTTPS (main entry point)
      - "8080:8080"   # ✅ Expose dashboard (http://localhost:8080)
    
    volumes:
      # Mount Docker socket so Traefik can read container info
      - /var/run/docker.sock:/var/run/docker.sock:ro     # ✅ Read-only Docker socket
    
    networks:
      - pong-network  # ✅ Same network as other services
    
    restart: unless-stopped  # ✅ Auto-restart if it crashes

  # ===== END OF NEW TRAEFIK SERVICE =====
  frontend:
    build:
      context: ./frontend
      dockerfile: Dockerfile.dev
    container_name: frontend
    
    expose:
      - "5173"
    networks:
      - pong-network
    volumes:
      - ./frontend:/app
      - /app/node_modules # Anonymous volume preserves container-built node_modules for hot-reload
    labels:
     # Enable Traefik for this container
      - "traefik.enable=true"                                                    # ✅ Tell Traefik to route to this container
      
      # Router configuration (when to route here)
      - "traefik.http.routers.frontend.rule=Host(`localhost`)"                  # ✅ Match domain "localhost"
      - "traefik.http.routers.frontend.entrypoints=websecure"                   # ✅ Use HTTPS (port 443)
      - "traefik.http.routers.frontend.priority=1"                              # ✅ Lowest priority (catch-all route)
      - "traefik.http.routers.frontend.tls=true"                                # ✅ Enable TLS/SSL
      
      # Service configuration (how to connect to this container)
      - "traefik.http.services.frontend.loadbalancer.server.port=5173"
  gateway-service:
    build:
      context: ./services/gateway-service
      dockerfile: Dockerfile
    container_name: gateway-service
    environment:
      - NODE_ENV=${NODE_ENV:-development}
      - JWT_SECRET=${JWT_SECRET:-}
    expose:
      - "3000"
    networks:
      - pong-network
    healthcheck:
      test: ["CMD", "curl", "-f","http://localhost:3000/test/status"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 10s
    volumes: #REMOVE FOR production
      - ./services/gateway-service:/gateway-service
      - /gateway-service/node_modules # Anonymous volume preserves container-built node_modules for hot-reload
    # ===== ADD THIS ENTIRE LABELS BLOCK (NEW) =====
    labels:
      - "traefik.enable=true"                                                    # ✅ Enable Traefik
      
      # API Router (for /api and /users paths)
      - "traefik.http.routers.gateway-api.rule=Host(`localhost`) && (PathPrefix(`/api`) || PathPrefix(`/users`))"  # ✅ Match /api/* or /users/*
      - "traefik.http.routers.gateway-api.entrypoints=websecure"                # ✅ Use HTTPS
      - "traefik.http.routers.gateway-api.priority=10"                          # ✅ Higher priority than frontend
      - "traefik.http.routers.gateway-api.tls=true"                             # ✅ Enable TLS
      
      # WebSocket Router (for /ws paths)
      - "traefik.http.routers.gateway-ws.rule=Host(`localhost`) && PathPrefix(`/ws`)"  # ✅ Match /ws/*
      - "traefik.http.routers.gateway-ws.entrypoints=websecure"                 # ✅ Use HTTPS (auto-upgrades to WSS)
      - "traefik.http.routers.gateway-ws.priority=20"                           # ✅ Highest priority
      - "traefik.http.routers.gateway-ws.tls=true"                              # ✅ Enable TLS
      
      # Service configuration (applies to both routers)
      - "traefik.http.services.gateway.loadbalancer.server.port=3000"           # ✅ Internal container port
    # ===== END OF LABELS =====
  game-service:
    build:
      context: ./services/game-service
      dockerfile: Dockerfile
    container_name: game-service
    expose:
      - "5000"    # HTTP endpoint
      - "5001"    # Another endpoint
      - "5002"    # Another endpoint
      - "5005"    # Classic WebSocket (if used)
      - "5006"    # Tournament WebSocket (if used)
    env_file:
      - .env
    environment:
      - MATCH_HISTORY_SERVICE_TOKEN=${MATCH_HISTORY_SERVICE_TOKEN}
    networks:
      - pong-network
    healthcheck:
      test: ["CMD", "curl", "-f","http://localhost:5000/test/status"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 10s
    volumes: #REMOVE FOR production
      - ./services/game-service:/game-service
      - /app/node_modules

  user-service:
    build:
      context: ./services/user-service
      dockerfile: Dockerfile
    container_name: user-service
    expose:
      - "8000"
    env_file:
      - .env
    environment:
      - NODE_ENV=development
      - MATCH_HISTORY_SERVICE_TOKEN=${MATCH_HISTORY_SERVICE_TOKEN}
    depends_on:
      - blockchain-service
    networks:
      - pong-network
    volumes:
      #- /user-service/node_modules # anonymous volume keeps Linux-built binaries
      - user-service-db:/user-service/data

  blockchain-service:
    build:
      context: ./services/blockchain-service
      dockerfile: Dockerfile
    container_name: blockchain-service
    # NO PORTS - this is a library service
    env_file:
      - .env
    networks:
      - pong-network
    volumes:
      - ./services/blockchain-service:/blockchain-service
      - /blockchain-service/node_modules
    environment:
      - NODE_ENV=development
      # No PORT needed
  ai-service:
    build:
      context: ./services/AI-service
      dockerfile: Dockerfile
    container_name: AI-service
    expose:
      - "5100"
    env_file:
      - .env
    networks:
      - pong-network
    healthcheck:
      test: ["CMD", "curl", "-f","http://localhost:5100/api/v1/aibot/test/status"]
      interval: 1m30s
      timeout: 30s
      retries: 5
      start_period: 10s

volumes:
     user-service-db:

networks:
  pong-network:
